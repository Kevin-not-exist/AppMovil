<html leng="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Movil</title>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css"> -->
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsenui.css">
    <link rel="stylesheet" href="https://unpkg.com/onsenui/css/onsen-css-components.min.css">
    <script src="https://unpkg.com/onsenui/js/onsenui.min.js"></script>
    <link rel="stylesheet" href="css/styles.css">
    <script src="js/functions.js"></script>
</head>

<body>
    <template id="t_info_especialista">
        <ons-page id="p_info_especialista">
            <script>
                ons.getScriptPage().onShow = function(){
                    const especialista = this.data.id;
                    console.log('especialista ' + especialista);


                    $(document).on("click", "#btn_reserva_medica", function(){
                        
                        var dialog = document.getElementById('my-alert-dialog');

                        if (dialog) {
                            dialog.show();
                        } else {
                            ons.createElement('alert-dialog-reserva', { append: true,data:{
                            id:especialista
                        }})
                            .then(function(dialog) {
                                dialog.show();
                            });
                        }                      
                    })

                    const url= `https://ort-api.herokuapp.com/medicos/${especialista}`;
                    $.ajax({
                        url:url,
                        data: "GET",
                        dataType: "json",
                        headers:{
                            'Authorization':'Bearer eyJhbGciOiJIUzI1NiJ9.eyJpZCI6IjVmMThiODg1NmFhNTVlMDAxNzg2OTM2MSIsInRpcG8iOiJVIn0.Q5dLLw34WiglquYv1Li6OGOcMdAZQHpBPq_PlAnAmmc'
                        },
                        success:function(informacion){
                            let item = "";
                                item = `
                                <ons-card>
                                    <img src="https://ort-api.herokuapp.com/imagenes/medicos/${informacion._id}.png" alt="Onsen UI" style="width: 100%">
                                    <div class="title">
                                        <h3>${informacion.nombre} ${informacion.apellido}</h3>
                                    </div>
                                    <div class="content">
                                        <p>Puntuaci&oacute;n: ${informacion.puntuacion}</p>
                                        <p>Promedio: ${informacion.promedio}</p>
                                        <p>${informacion.email}</p>
                                        <p><input type="text" id="id_medico_reserva" value="${informacion._id}"></p>
                                    </div>
                                </ons-card>`
                                $("#info_especialista").html(item);
                        },
                        error:function (xml_request, err, status) {
                            ons.notification.toast(xml_request.responseJSON.descripcion, {"timeout": 3000});
                        }

                    })
                }
            </script>
             <ons-fab position="bottom right">
                <ons-icon icon="md-plus" id="btn_reserva_medica"></ons-icon>
              </ons-fab>
            <section>
                <ons-list id="info_especialista"></ons-list>
            </section>
        </ons-page>
    </template>

    <template id="alert-dialog-reserva">
        <ons-alert-dialog id="my-alert-dialog" modifier="rowfooter">
            <script>
                const id =  $("#id_medico_reserva").val();
                $("#id_medico").html(id);
            </script>
            <div class="alert-dialog-title">Reserva Médica</div>
          <div class="alert-dialog-content">
            <label for="fecha_reserva_medica">Fecha</label>
            <p><input type="date" id="fecha_reserva_medica"></p>
            
            <label for="hora_reserva_medica">Hora</label>
            <p><input type="time" id="hora_reserva_medica"></p>
          </div>
          <div class="alert-dialog-footer">
            <ons-alert-dialog-button id="btn_salir_reserva_medica">Cancel</ons-alert-dialog-button>
            <ons-alert-dialog-button id="btn_enviar_reserva_medica">OK</ons-alert-dialog-button>
          </div>
        </ons-alert-dialog>
    </template>

    <template id="t_especialistas">
        <ons-page id="p_especialistas">
            <script>
                ons.getScriptPage().onInit = function(){

                    $(document).on("click", ".especialista", function(){
                        const id = $(this).data("id");
                        nav.pushPage("t_info_especialista", {data:{
                            id:id
                        }})
                    })
                }
                ons.getScriptPage().onShow=function(){

                    const especialidad = this.data.id;
                    const url= `https://ort-api.herokuapp.com/medicos/especialidad/?buscar=${especialidad}`
                    $.ajax({
                        url:url,
                        data: "GET",
                        dataType: "json",
                        headers: {
                            'Authorization': 'Bearer eyJhbGciOiJIUzI1NiJ9.eyJpZCI6IjVmMThiODg1NmFhNTVlMDAxNzg2OTM2MSIsInRpcG8iOiJVIn0.Q5dLLw34WiglquYv1Li6OGOcMdAZQHpBPq_PlAnAmmc '
                        },
                        success:function(especialistas){
                            let item="";
                            let itemMedico="";
                            $.each(especialistas, function(i, especialista){
                                item = `<ons-list-item modifier = "chevron longdivider" class="especialista" data-id = '${especialista._id}'  tappable tap-background-color="#3ED47A">
                                        <div class="left">
                                            <img class="list-item__thumbnail" src="https://ort-api.herokuapp.com/imagenes/medicos/${especialista._id}.png">
                                        </div>
                                        <div class="center">
                                            <span class="list-item__title">${especialista.nombre}</span><span class="list-item__subtitle">${especialista.apellido}</span>
                                        </div>
                                        </ons-list-item>`;
                                $("#listado_especialistas").append(item);
                            });
                        },
                        error: function (xml_request, err, status) {
                            ons.notification.toast(xml_request.responseJSON.descripcion, {
                                "timeout": 3000
                            });
                        }
                    })
                }

            </script>
            <section>
                <ons-list id="listado_especialistas">
                <ons-list-title>Listado de especialistas</ons-list-title>
                </ons-list>
            </section>
        </ons-page>
    </template>

    <template id="t_especialidades_disponibles">
        <ons-page id="p_especialidades_disponibles">
            <script>
                ons.getScriptPage().onInit = function(){

                    $(document).on("click", ".l_esp_disponibles", function(){
                        const id = $(this).data("id");
                        nav.pushPage("t_especialistas", {data:{
                            id:id
                        }})
                    })
                }
            </script>
            <ons-toolbar>
                <div class="left">
                    <ons-toolbar-button icon="fa-bars" onclick="fn.open()"></ons-toolbar-button>
                </div>
                <div class="center">Especialidades</div>
            </ons-toolbar>
            <section>
                <ons-list>
                    <ons-list-item class="l_esp_disponibles" data-id = "Cardiolog&iacute;a">
                        <div class="center">
                            <span>Cardiolog&iacute;a</span>
                        </div>
                    </ons-list-item>
                    <ons-list-item class="l_esp_disponibles" data-id = "Oftalmolog&iacute;a">
                        <div class="center">
                            <span>Oftalmolog&iacute;a</span>
                        </div>
                    </ons-list-item>
                    <ons-list-item class="l_esp_disponibles" data-id = "Neumolog&iacute;a">
                        <div class="center">
                            <span>Neumolog&iacute;a</span>
                        </div>
                    </ons-list-item>
                    <ons-list-item class="l_esp_disponibles" data-id = "Reumatolog&iacute;a">
                        <div class="center">
                            <span>Reumatolog&iacute;a</span>
                        </div>
                    </ons-list-item>
                    <ons-list-item class="l_esp_disponibles" data-id = "Psiquiatr&iacute;a">
                        <div class="center">
                            <span>Psiquiatr&iacute;a</span>
                        </div>
                    </ons-list-item>
                    <ons-list-item class="l_esp_disponibles" data-id = "Geriatr&iacute;a">
                        <div class="center">
                            <span>Geriatr&iacute;a</span>
                        </div>
                    </ons-list-item>
                    <ons-list-item class="l_esp_disponibles" data-id = "Neurocirug&iacute;a">
                        <div class="center">
                            <span>Neurocirug&iacute;a</span>
                        </div>
                    </ons-list-item>
                    <ons-list-item class="l_esp_disponibles" data-id = "Oncolog&iacute;a">
                        <div class="center">
                            <span>Oncolog&iacute;a</span>
                        </div>
                    </ons-list-item>
                    <ons-list-item class="l_esp_disponibles" data-id = "Traumatolog&iacute;a">
                        <div class="center">
                            <span>Traumatolog&iacute;a</span>
                        </div>
                    </ons-list-item>
                </ons-list>
            </section>
        </ons-page>
    </template>

    <ons-modal direction="up" id="cargando">
        <div style="text-align: center">
            <p>
                <ons-icon icon="md-spinner" size="28px" spin></ons-icon> <span id="txt_cargando"></span>
            </p>
        </div>
    </ons-modal>
    <ons-splitter>
        <ons-splitter-side id="menu" side="left" width="220px" collapse swipeable>
            <ons-page>
                <ons-list>
                    <ons-list-item onclick="fn.load('t_especialidades_disponibles','p_especialidades_disponibles')" modifier="chevron" tappabletap-background-color="#3ED47A">
                        <ons-icon icon="fa-store" size="20px" style="color:#3ED47A"></ons-icon>&nbsp;Especialidades Disponibles
                    </ons-list-item>
                    <ons-list-item id="btn_logout" modifier="chevron" tappable tap-background-color="#3ED47A">
                        <ons-icon icon="fa-sign-out-alt" size="20px"></ons-icon>&nbsp;Cerrar Sesi&oacute;n
                    </ons-list-item>
                    <ons-list-item onclick="fn.load('menu')" tappable>
                        Salir
                    </ons-list-item>
                </ons-list>
            </ons-page>
        </ons-splitter-side>
        <ons-splitter-content id="content">
            <ons-navigator id="nav" page="t_login"></ons-navigator>
        </ons-splitter-content>
    </ons-splitter>

    <template id="t_login">
        <ons-page id="p_login">
            <script>
                ons.getScriptPage().onShow = function () {
                    if (localStorage.getItem("email")) {
                        const recordar = document.getElementById('swt_recordar_password');

                        //si hay usuario grabado en localStorage, dejo marcado switch y hago login.
                        recordar.setAttribute('checked', 'true');
                        const email = localStorage.getItem("email");
                        const pwd = localStorage.getItem("password");
                        login(email, pwd);
                    }
                }

                ons.getScriptPage().onInit = function () {

                    $(document).on("click", "#btn_login", function () {
                        try {
                            const email = $("#login_usuario").val();
                            const pwd = $("#inp_login_pwd").val();
                            const tipo = $("#tipo_login").val();
                            if (!email) {
                                throw "Ingrese email para continuar";
                            }
                            if (!pwd) {
                                throw "Ingrese contraseña para continuar";
                            }
                            if (!tipo) {
                                throw "Ingrese tipo para continuar";
                            }
                            login(email, pwd, tipo);
                        }
                        catch (e) {
                            ons.notification.toast(e, { "timeout": 3000 });
                        }
                    });

                    $(document).on("click", "#btn_login_registro", function () {
                        //Redirecciono a registro
                        fn.load("t_registro", "p_registro");
                    });

                    $(document).on("click", "#mostrar_pwd", function () {
                        //si el elemento tiene como atributo icon fa-eye lo cambio a fa-eye-slash y viceversa. 
                        if ($(this).attr("icon") == 'fa-eye') {
                            $(this).attr("icon", "fa-eye-slash");
                            //cambio tipo de input a password.
                            $("#inp_login_pwd").attr("type", "password");
                        }
                        else {
                            //ver password
                            $(this).attr("icon", "fa-eye");
                            //cambio tipo de input a input.
                            $("#inp_login_pwd").attr("type", "input");
                        }
                    });
                    $(document).on("click", "#swt_recordar_password", function () {
                        const recordar = document.getElementById('swt_recordar_password');
                        if (recordar.checked) {
                            const email = $("#login_usuario").val();
                            const pwd = $("#inp_login_pwd").val();
                            //grabo el localStorage.
                            localStorage.setItem("email", email);
                            localStorage.setItem("password", pwd);
                        }
                        else {
                            //remuevo de localStorage.
                            localStorage.removeItem("email");
                            localStorage.removeItem("password");
                        }
                    });
                }
            </script>
            <section>
                <h1>Login de Usuario</h1>
                <label for="login_usuario"></label>
                <p><input class="text-input text-input--material" type="text" id="login_usuario" placeholder="Ingrese usuario"></p>

                <label for="inp_login_pwd"></label>
                <p><input class="text-input text-input--material" type="password" id="inp_login_pwd"placeholder="Ingrese contrase&ntilde;a">
                    <ons-icon icon="fa-eye-slash" id="mostrar_pwd"></ons-icon>
                <p>
                    <ons-select id="tipo_login">
                        <option value="">Seleccione una opción</option>
                        <option value="U">Usuario</option>
                        <option value="M">Médico</option>
                    </ons-select>
                </p>
                <p>
                    <ons-button id="btn_login">Login</ons-button>
                    <ons-button modifier="outline" id="btn_login_registro">Registro</ons-button>
                </p>
                <ons-switch modifier="material" id="swt_recordar_password" input-id="swt_recordar_password2">
                </ons-switch>
                <!-- Si hace click sobre el texto Recordar contraseña, activar switch. -->
                <label for="swt_recordar_password2">Recordar contrase&ntilde;a</label>
            </section>
        </ons-page>
    </template>


    <template id="t_registro">
        <ons-page id="p_registro">
            <section>
                <h1>Registro de usuario</h1>
                <label for="nombre">Nombre</label>
                <p><input type="text" class="text-input text-input--material" id="nombre" placeholder="Ingrese nombre">
                </p>
                <label for="apellido">Apellido</label>
                <p><input type="text" class="text-input text-input--material" id="apellido" placeholder="Ingrese apellido"></p>
                <label for="email">Email</label>
                <p><input type="text" class="text-input text-input--material" id="email" placeholder="Ingrese email">
                </p>
                <label for="pwd">Contrase&ntilde;a</label>
                <p><input type="password" class="text-input text-input--material" id="pwd" placeholder="Ingrese contraseña"></p>
                <label for="repwd">Re contrase&ntilde;a</label>
                <p><input type="password" class="text-input text-input--material" id="repwd" placeholder="Repita la contraseña"></p>
                <label for="telefono">Teléfono</label>
                <p><input type="text" class="text-input text-input--material" id="telefono" placeholder="Teléfono"></p>
                <label for="documento">Documento</label>
                <p><input type="text" class="text-input text-input--material" id="documento" placeholder="De 7 a 8 digitos..."></p>
                <p>
                    <ons-select id="genero">
                        <option value="">Seleccione una opci&oacute;n</option>
                        <option value="M">Masc</option>
                        <option value="F">Fem</option>
                    </ons-select>
                </p>
                <p>
                    <ons-button id="btn_registro">Registrarse</ons-button>
                </p>
            </section>
        </ons-page>
    </template>
</body>

</html>